---
title: "Dengue Forecast in Singapore"
author: "Colin Jiang Kelin"
date: " 17, 2024"
date-modified: "last-modified"
execute: 
  eval: true
  echo: true
  freeze: true
  message: false
  warning: false
editor: visual
---

```{r}

pacman::p_load(
  shiny,
  tidyverse,
  fable,
  tsibble,
  feasts,
  patchwork,
  ggstatsplot,
  MLmetrics,
  performance,
  caret,
  qqplotr,
  lubridate,
  ggthemes, 
  sf, 
  terra, 
  gstat, 
  automap, 
  tmap, 
  viridis, 
  zoo,
  rstantools,
  urca
)
```

# Data Import

```{r}
df <- read_csv("data/dengue_climate_joined_by_week_transformed_diff.csv")
```

## ARIMA

### Data Preparation

```{r}
arima_ts <-  df %>% dplyr::select(Date, Cases)
arima_tbl <- arima_ts %>% as_tsibble(index = Date) %>% fill_gaps(.full = TRUE) %>% fill(Cases)
```

### Model

```{r}
arima_mdl <- arima_tbl %>% 
  model('arima' = ARIMA(Cases))
```

### Residual

```{r}
arima_mdl %>% gg_tsresiduals()
```

### Extracting params

```{r}
a <- capture.output(report(arima_mdl))
c <- ""
for (b in a) {
  c <- paste0(c,b,"\n")
}
params <- gsub("[\\(\\)]", "", regmatches(c, gregexpr("\\(.*?\\)", c))[[1]])
params <- as.list(strsplit(params, ',')[[1]])
params[[2]]
```

### Autocorrelation

```{r}
arima_tbl %>% gg_tsdisplay(difference(Cases,1), plot_type = 'partial')
```

### Actual vs Predicted

```{r}
arima_fitted <- fitted(arima_mdl)[,2:3] %>% 
  as_tibble() %>% 
  rename(Cases=.fitted)

arima_fitted$Type <- "Fit"

arima_tbl$Type <- "Observed"

arima_avp <- dplyr::bind_rows(arima_fitted, arima_tbl)

ggplotly(
  ggplot(data = arima_avp) +
    geom_line(aes(x = Date, y = Cases, colour = Type)) +
    ggtitle("Observed vs Fitted")
)
```

### Model Metrics

```{r}

arima_cv <- arima_tbl %>%
  stretch_tsibble(.init = 200, .step = 10) 


arima_cv_metrics <- arima_cv %>%
  model(ARIMA(Cases)) %>%
  forecast(h = 1) %>%
  accuracy(arima_tbl)


arima_train_metrics <- arima_mdl %>%
  accuracy()
```

```{r}
arima_cv_metrics[c("RMSE","MAE","MAPE")]
```

### Forecast

```{r}
arima_mdl %>%
  forecast(h = 26) %>%
  autoplot(arima_tbl)
```

```{r}
results <- arima_mdl %>%
  forecast(h = 26)

results <- results[-c(1,3)]
colnames(results) <- c("Date", "Forecast")

results
```

## Exponential Smoothing

### Data Preparation

```{r}
ets_ts <-  df %>% dplyr::select(Date, Cases)
ets_tbl <- ets_ts %>% as_tsibble(index = Date) %>% fill_gaps(.full = TRUE) %>% fill(Cases)
```

### Model

```{r}
ets_mdl <- ets_tbl %>%
  model(ETS(Cases))

report(ets_mdl)
```

### Extracting Params

```{r}
a <- capture.output(report(ets_mdl))
para1 <- ""
para2 <- ""
para3 <- ""
c <- ""
for (b in a) {
  if (grepl("alpha", b)) {
    para1 <- as.list(strsplit(b, ' = ')[[1]])
    para1 <- trimws(para1[[2]])
  }
  if (grepl("beta", b)) {
    para2 <- as.list(strsplit(b, ' = ')[[1]])
    para2 <- trimws(para2[[2]])
  }
  if (grepl("gamma", b)) {
    para3 <- as.list(strsplit(b, ' = ')[[1]])
    para3 <- trimws(para3[[2]])
  }
  c <- paste0(c,b,"\n")
}
params <- gsub("[\\(\\)]", "", regmatches(c, gregexpr("\\(.*?\\)", c))[[1]])
params <- as.list(strsplit(params, ',')[[1]])
para4 <- params[[1]]
para5 <- params[[2]]
para6 <- params[[3]]

```

### Decomposition

```{r}
components(ets_mdl) %>%
  autoplot() +
  labs(title = "Exponential Smoothing Components")
```

```{r}
autoplot(ets_tbl)
```

### Actual vs Predicted

```{r}
ets_fitted <- fitted(ets_mdl)[,2:3] %>% 
  as_tibble() %>% 
  rename(Cases=.fitted)

ets_fitted$Type <- "Fit"

ets_tbl$Type <- "Observed"

ets_avp <- dplyr::bind_rows(ets_fitted, ets_tbl)

ggplotly(
  ggplot(data = ets_avp) +
    geom_line(aes(x = Date, y = Cases, colour = Type)) +
    ggtitle("Observed vs Fitted")
)
```

### Model Metrics

```{r}
ets_cv <- ets_tbl %>%
  stretch_tsibble(.init = 200, .step = 10) 


ets_cv_metrics <- ets_cv %>%
  model(ARIMA(Cases)) %>%
  forecast(h = 1) %>%
  accuracy(ets_tbl)


ets_train_metrics <- ets_mdl %>%
  accuracy()
```

```{r}
ets_cv_metrics$MAPE
```

### Forecast

```{r}
ets_mdl %>%
  forecast(h = 26) %>%
  autoplot(ets_tbl)
```

## VAR

### Data Preparation

```{r}
var_ts <-  df %>% dplyr::select(-c("Year", "WkNo"))
var_tbl <- var_ts %>% as_tsibble(index = Date) %>% fill_gaps(.full = TRUE) %>% fill(colnames(var_ts))
```

### Model

```{r}
var_mdl <- var_tbl %>%
  model(
    aicc = VAR(vars(Cases, avg_mean_temp, avg_daily_rainfall), ic="aicc")
  )
```

### Formula construction

```{r}
i <- c("avg_temp")
```

```{r}
v <- "Cases"
mode <- '"aicc"'

for (s in i) {
  v <- paste0(v,",",s)
}

strr <- paste0('var_tbl %>% model(',mode,' = VAR(vars(',v,'), ic=',mode,'))')

var_mdl <- eval(parse(text = strr))
```

### Autocorrelation

```{r}
var_mdl |>
  augment() |>
  ACF() |>
  autoplot()
```

### Actual vs Predicted

```{r}
var_fitted <- fitted(var_mdl)[,2:3] %>% 
  as_tibble() #%>% 
  #rename(Cases=.fitted)

var_fitted$Type <- "Fit"

var_tbl$Type <- "Observed"

var_avp <- dplyr::bind_rows(var_fitted, var_tbl)

ggplotly(
  ggplot(data = var_avp) +
    geom_line(aes(x = Date, y = Cases, colour = Type)) +
    ggtitle("Observed vs Fitted")
)
```

### Model Metrics

```{r}
var_cv <- var_tbl %>%
  stretch_tsibble(.init = 200, .step = 10) 


var_cv_metrics <- var_cv %>%
  model(
    aicc = VAR(vars(Cases))
    ) %>%
  forecast(h = 1) %>%
  accuracy(var_tbl)
```

```{r}
var_cv_metrics
```

### Forecast

```{r}

fc <- var_mdl %>% 
  forecast(h = 26)

fc %>% autoplot(var_tbl)
```

```{r}
v <- "avg_rainfall"

var_fc <- data.frame(Date=fc$Date, 
                     temp=fc$.mean[,v],
                     lwr80=ci$`80%`[[v]]$lower,
                     upr80=ci$`80%`[[v]]$upper,
                     lwr95=ci$`95%`[[v]]$lower,
                     upr95=ci$`95%`[[v]]$upper,
                     Type="Forecast")

colnames(var_fc)[2] <- v

var_obs <- data.frame(Date=var_tbl$Date, 
                      temp=var_tbl[v],
                      lwr80=NA,
                      upr80=NA,
                      lwr95=NA,
                      upr95=NA,
                      Type="Observed")

var_plot <- dplyr::bind_rows(var_obs, var_fc)
```

```{r}
ci <- hilo(fc)

ci$`80%`[[v]]$lower
```

```{r}
ggplot(data = var_plot, aes(x=Date, y=.data[[v]] ,colour=Type)) + 
  geom_line() +
  geom_ribbon(aes(ymin=lwr80, ymax=upr80), alpha=0.2, linetype=0, fill="blue") +
  geom_ribbon(aes(ymin=lwr95, ymax=upr95), alpha=0.1, linetype=0, fill="blue") + 
  scale_colour_manual(values = c("Observed"="black", "Forecast"="blue")) +
  ggtitle(paste0("Forecast ",v," for next n periods"))
```

### Coeffs

```{r}
ggcoefstats(var_mdl %>% broom::tidy())
```
